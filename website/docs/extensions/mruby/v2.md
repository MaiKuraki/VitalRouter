---
sidebar_label: v2  
title: VitalRouter.MRuby v2
---

## Installation

VitalRouter.MRuby は、ピュアC# による mruby vm 実装である [MRubyCS](https://github.com/hadashiA/MRubyCS) を利用します。
以下の手順で、MRubyCS関連のパッケージと、VitalRouter.MRubyパッケージをインストールしてください。

VitalRouter.MRuby v2 は、C#の動作するあらゆるプラットフォームをサポートします。

### NuGet

Install following packages.

```bash
dotnet add MRubyCS 
dotnet add MRubyCS.Compiler 
dotnet add MRubyCS.Serializer 
dotnet add VitalRouter.MRuby 
```

### Unity

1. Install [NuGetForUnity](https://github.com/GlitchEnzo/NuGetForUnity)
2. Open the NuGet window by going to NuGet > Manage NuGet Packages, and install following packages.
  - MRubyCS
  - MRubyCS.Serializer
  - VitalRouter.MRuby
3. Install [MRubyCS.Compiler](https://github.com/hadashiA/MRubyCS?tab=readme-ov-file#mrubycscompiler) unity package.

## Getting Started

mruby を実行するには、まず `MRubyState` を作成します。
mruby世界のオブジェクトの生成やメソッド実行は、すべて `MRubyState` を介して行われます。

```cs
using MRubyCS;

var mrb = MRubyState.Create();
```

VitalRouter.MRuby パッケージが導入されているとき、`MRubyState.DefineVitalRouter` 拡張メソッドが有効になります。

mrubyスクリプトを介して発行したい `ICommand` の実装を、MRubyStateに登録しましょう。

```cs
mrb.DefineVitalRouter(x => 
{
    x.AddCommand<CharacterMoveCommand>("move");
    x.AddCommand<CharacterSpeakCommand>("speak");
});
```

引数の文字列 ("move" とか、"speak" とか) は、rubyからそのコマンドを扱うときの名前を自由につけることができます。

`AddCommand` の型パラメーターには、あなたがrubyから発行したい 任意の `ICommand` 型を指定します。
ここで指定する型には、`[MRubyObject]` attribute が必要であることに注意してください。


```cs
// Your custom command decralations
[MRubyObject]
partial struct CharacterMoveCommand : ICommand
{
    public string Id;
    public Vector3 To;
}

[MRubyObject]
partial struct CharacterSpeakCommand : ICommand
{
    public string Id;
    public string Text;
}
```

これで、上記のコマンドをRubyから発行できるようになりました。

たとえば以下のようなRubyソースコードを準備します。

```ruby
cmd :speak, id: 'Bob', text: 'Hello'
```

```cs
// compile to bytecode


mrb.ExecuteAsync();
```

### `[MRubyObject]`


:::note
`[MRubyObject]` attribute は、 [MRubyCS.Serializer](https://github.com/hadashiA/MRubyCS?tab=readme-ov-file#mrubycsserializer)
:::

### SharedVariableTable

### Define Ruby Method from C#
