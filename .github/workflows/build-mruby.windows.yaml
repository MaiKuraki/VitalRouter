name: Build mruby (Windows)
on:
  workflow_call:
  workflow_dispatch:
    
env:
  MRUBY_DIR: ${{ github.workspace }}/src/vitalrouter-mruby/ext/mruby
  CONFIG_DIR: ${{ github.workspace }}/src/vitalrouter-mruby
    
jobs:
  build-windows:
    runs-on: windows-latest
    outputs:
      artifact-url: ${{ steps.upload-windows-build.artifact-url }}
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: mswin

    - uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64

    - name: Build mruby (windows x86)
      working-directory: ${{ env.MRUBY_DIR }}
      shell: bash
      run: |
        MRUBY_CONFIG=${{ env.CONFIG_DIR }}/build_config.windows.rb rake
        
    - uses: actions/upload-artifact@v3
      id: upload-windows-build
      with:
        name: windows-build
        path: ${{ env.MRUBY_DIR }}/build
        
        
      

    
    
